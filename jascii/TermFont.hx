package jascii;

import haxe.macro.Expr;

class TermFont
{
    var data:Array<Array<Int>>;

    public function new()
    {
        this.data = TermFont.get_font();
    }

    public inline function iter_char(ordinal:Int):Iterator<Iterator<Bool>>
    {
        var char:Array<Int> = this.data[ordinal - (" ".code)];

        var y:Int = 0;
        return {
            hasNext: inline function() return y < char.length * 2,
            next: inline function() {
                var row:Int = char[y >> 1];
                var and:Int = y++ % 2 == 0 ? 1 << TermFont.WIDTH : 1;
                var x:Int = 0;
                return {
                    hasNext: inline function() return x < TermFont.WIDTH,
                    next: inline function() return (row >> x++) & and != 0
                };
            }
        };
    }

    macro public static function get_font():Expr
    {
        var font:Array<Array<Int>> = new Array();

        var cells:Int =
            Std.int(TermFont.DATA.length / TermFont.HEIGHT);

        var blocks:Int = Std.int(cells / TermFont.BLOCKSIZE);

        for (i in 0...TermFont.DATA.length) {
            var block:Int =
                Std.int(i / (TermFont.HEIGHT * TermFont.BLOCKSIZE));

            var cellblock_start:Int = TermFont.BLOCKSIZE * block;

            var current_blocksize:Int = block >= blocks
                ? (cells % blocks) % TermFont.BLOCKSIZE
                : TermFont.BLOCKSIZE;

            var cell:Int = i % current_blocksize + cellblock_start;

            var is_odd:Bool =
                (Std.int(i / current_blocksize) -
                    (TermFont.HEIGHT * cellblock_start))
                % 2 != 0;

            var row:Int = 0;

            for (j in 0...TermFont.WIDTH)
                row |= TermFont.DATA[i].charCodeAt(j) != " ".code
                    ? 1 << j : 0;

            if (font[cell] == null) {
                font.insert(cell, [row]);
                continue;
            }

            if (is_odd)
                font[cell][font[cell].length - 1] |= row;
            else
                font[cell].push(row << TermFont.DATA[i].length);
        }

        var out:Array<Expr> = new Array();

        for (cell in font) {
            var cell_out:Array<Expr> = new Array();

            for (y in cell) {
                cell_out.push({
                    expr: EConst(CInt(Std.string(y))),
                    pos: haxe.macro.Context.currentPos()
                });
            }

            out.push({
                expr: EArrayDecl(cell_out),
                pos: haxe.macro.Context.currentPos()
            });
        }

        return {
            expr: EArrayDecl(out),
            pos: haxe.macro.Context.currentPos()
        };
    }

    public static inline var BLOCKSIZE:Int = 6;
    public static inline var WIDTH:Int     = 8;
    public static inline var HEIGHT:Int    = 16;

#if macro
    public static var DATA:Array<String> = [
    //  |<---------------- this is considered to be a block ---------------->|
    //  +--------.  .--------.  .--------.  .--------.  .--------.  .--------+
    //  | cell 0 |  | cell 1 |  | cell 2 |  | cell 3 |  | cell 4 |  | cell 5 |
        "        ", "        ", "        ", "        ", "   ##   ", "        ",
        "        ", "        ", " ##  ## ", "        ", "   ##   ", "        ",
        "        ", "   ##   ", " ##  ## ", "        ", " #####  ", "        ",
        "        ", "  ####  ", " ##  ## ", " ## ##  ", "##   ## ", "        ",
        "        ", "  ####  ", "  #  #  ", " ## ##  ", "##    # ", "##    # ",
        "        ", "  ####  ", "        ", "####### ", "##      ", "##   ## ",
        "        ", "   ##   ", "        ", " ## ##  ", " #####  ", "    ##  ",
        "        ", "   ##   ", "        ", " ## ##  ", "     ## ", "   ##   ",
        "        ", "   ##   ", "        ", " ## ##  ", "     ## ", "  ##    ",
        "        ", "        ", "        ", "####### ", "#    ## ", " ##     ",
        "        ", "   ##   ", "        ", " ## ##  ", "##   ## ", "##   ## ",
        "        ", "   ##   ", "        ", " ## ##  ", " #####  ", "#    ## ",
        "        ", "        ", "        ", "        ", "   ##   ", "        ",
        "        ", "        ", "        ", "        ", "   ##   ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",

        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "  ##    ", "        ", "        ", "        ", "        ",
        "  ###   ", "  ##    ", "    ##  ", "  ##    ", "        ", "        ",
        " ## ##  ", "  ##    ", "   ##   ", "   ##   ", "        ", "        ",
        " ## ##  ", " ##     ", "  ##    ", "    ##  ", "        ", "        ",
        "  ###   ", "        ", "  ##    ", "    ##  ", " ##  ## ", "   ##   ",
        " ### ## ", "        ", "  ##    ", "    ##  ", "  ####  ", "   ##   ",
        "## ###  ", "        ", "  ##    ", "    ##  ", "########", " ###### ",
        "##  ##  ", "        ", "  ##    ", "    ##  ", "  ####  ", "   ##   ",
        "##  ##  ", "        ", "  ##    ", "    ##  ", " ##  ## ", "   ##   ",
        "##  ##  ", "        ", "   ##   ", "   ##   ", "        ", "        ",
        " ### ## ", "        ", "    ##  ", "  ##    ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",

        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "  ####  ", "   ##   ",
        "        ", "        ", "        ", "        ", " ##  ## ", "  ###   ",
        "        ", "        ", "        ", "      # ", "##    ##", " ####   ",
        "        ", "        ", "        ", "     ## ", "##    ##", "   ##   ",
        "        ", "        ", "        ", "    ##  ", "## ## ##", "   ##   ",
        "        ", "####### ", "        ", "   ##   ", "## ## ##", "   ##   ",
        "        ", "        ", "        ", "  ##    ", "##    ##", "   ##   ",
        "   ##   ", "        ", "        ", " ##     ", "##    ##", "   ##   ",
        "   ##   ", "        ", "   ##   ", "##      ", " ##  ## ", "   ##   ",
        "   ##   ", "        ", "   ##   ", "#       ", "  ####  ", " ###### ",
        "  ##    ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",

        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        " #####  ", " #####  ", "    ##  ", "####### ", "  ###   ", "####### ",
        "##   ## ", "##   ## ", "   ###  ", "##      ", " ##     ", "##   ## ",
        "     ## ", "     ## ", "  ####  ", "##      ", "##      ", "     ## ",
        "    ##  ", "     ## ", " ## ##  ", "##      ", "##      ", "     ## ",
        "   ##   ", "  ####  ", "##  ##  ", "######  ", "######  ", "    ##  ",
        "  ##    ", "     ## ", "####### ", "     ## ", "##   ## ", "   ##   ",
        " ##     ", "     ## ", "    ##  ", "     ## ", "##   ## ", "  ##    ",
        "##      ", "     ## ", "    ##  ", "     ## ", "##   ## ", "  ##    ",
        "##   ## ", "##   ## ", "    ##  ", "##   ## ", "##   ## ", "  ##    ",
        "####### ", " #####  ", "   #### ", " #####  ", " #####  ", "  ##    ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",

        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        " #####  ", " #####  ", "        ", "        ", "        ", "        ",
        "##   ## ", "##   ## ", "        ", "        ", "     ## ", "        ",
        "##   ## ", "##   ## ", "   ##   ", "   ##   ", "    ##  ", "        ",
        "##   ## ", "##   ## ", "   ##   ", "   ##   ", "   ##   ", " ###### ",
        " #####  ", " ###### ", "        ", "        ", "  ##    ", "        ",
        "##   ## ", "     ## ", "        ", "        ", " ##     ", "        ",
        "##   ## ", "     ## ", "        ", "        ", "  ##    ", " ###### ",
        "##   ## ", "     ## ", "   ##   ", "   ##   ", "   ##   ", "        ",
        "##   ## ", "    ##  ", "   ##   ", "   ##   ", "    ##  ", "        ",
        " #####  ", " ####   ", "        ", "  ##    ", "     ## ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",

        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", " #####  ", "        ", "   #    ", "######  ", "  ####  ",
        " ##     ", "##   ## ", " #####  ", "  ###   ", " ##  ## ", " ##  ## ",
        "  ##    ", "##   ## ", "##   ## ", " ## ##  ", " ##  ## ", "##    # ",
        "   ##   ", "    ##  ", "##   ## ", "##   ## ", " ##  ## ", "##      ",
        "    ##  ", "   ##   ", "## #### ", "##   ## ", " #####  ", "##      ",
        "     ## ", "   ##   ", "## #### ", "####### ", " ##  ## ", "##      ",
        "    ##  ", "   ##   ", "## #### ", "##   ## ", " ##  ## ", "##      ",
        "   ##   ", "        ", "## ###  ", "##   ## ", " ##  ## ", "##    # ",
        "  ##    ", "   ##   ", "##      ", "##   ## ", " ##  ## ", " ##  ## ",
        " ##     ", "   ##   ", " #####  ", "##   ## ", "######  ", "  ####  ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",

        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "#####   ", "####### ", "####### ", "  ####  ", "##   ## ", "  ####  ",
        " ## ##  ", " ##  ## ", " ##  ## ", " ##  ## ", "##   ## ", "   ##   ",
        " ##  ## ", " ##   # ", " ##   # ", "##    # ", "##   ## ", "   ##   ",
        " ##  ## ", " ## #   ", " ## #   ", "##      ", "##   ## ", "   ##   ",
        " ##  ## ", " ####   ", " ####   ", "##      ", "####### ", "   ##   ",
        " ##  ## ", " ## #   ", " ## #   ", "## #### ", "##   ## ", "   ##   ",
        " ##  ## ", " ##     ", " ##     ", "##   ## ", "##   ## ", "   ##   ",
        " ##  ## ", " ##   # ", " ##     ", "##   ## ", "##   ## ", "   ##   ",
        " ## ##  ", " ##  ## ", " ##     ", " ##  ## ", "##   ## ", "   ##   ",
        "#####   ", "####### ", "####    ", "  ### # ", "##   ## ", "  ####  ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",

        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "   #### ", "###  ## ", "####    ", "##    ##", "##   ## ", " #####  ",
        "    ##  ", " ##  ## ", " ##     ", "###  ###", "###  ## ", "##   ## ",
        "    ##  ", " ##  ## ", " ##     ", "########", "#### ## ", "##   ## ",
        "    ##  ", " ## ##  ", " ##     ", "########", "####### ", "##   ## ",
        "    ##  ", " ####   ", " ##     ", "## ## ##", "## #### ", "##   ## ",
        "    ##  ", " ####   ", " ##     ", "##    ##", "##  ### ", "##   ## ",
        "##  ##  ", " ## ##  ", " ##     ", "##    ##", "##   ## ", "##   ## ",
        "##  ##  ", " ##  ## ", " ##   # ", "##    ##", "##   ## ", "##   ## ",
        "##  ##  ", " ##  ## ", " ##  ## ", "##    ##", "##   ## ", "##   ## ",
        " ####   ", "###  ## ", "####### ", "##    ##", "##   ## ", " #####  ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",

        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "######  ", " #####  ", "######  ", " #####  ", "########", "##   ## ",
        " ##  ## ", "##   ## ", " ##  ## ", "##   ## ", "## ## ##", "##   ## ",
        " ##  ## ", "##   ## ", " ##  ## ", "##   ## ", "#  ##  #", "##   ## ",
        " ##  ## ", "##   ## ", " ##  ## ", " ##     ", "   ##   ", "##   ## ",
        " #####  ", "##   ## ", " #####  ", "  ###   ", "   ##   ", "##   ## ",
        " ##     ", "##   ## ", " ## ##  ", "    ##  ", "   ##   ", "##   ## ",
        " ##     ", "##   ## ", " ##  ## ", "     ## ", "   ##   ", "##   ## ",
        " ##     ", "## # ## ", " ##  ## ", "##   ## ", "   ##   ", "##   ## ",
        " ##     ", "## #### ", " ##  ## ", "##   ## ", "   ##   ", "##   ## ",
        "####    ", " #####  ", "###  ## ", " #####  ", "  ####  ", " #####  ",
        "        ", "    ##  ", "        ", "        ", "        ", "        ",
        "        ", "    ### ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",

        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "##    ##", "##    ##", "##    ##", "##    ##", "########", "  ####  ",
        "##    ##", "##    ##", "##    ##", "##    ##", "##    ##", "  ##    ",
        "##    ##", "##    ##", " ##  ## ", "##    ##", "#    ## ", "  ##    ",
        "##    ##", "##    ##", "  ####  ", " ##  ## ", "    ##  ", "  ##    ",
        "##    ##", "##    ##", "   ##   ", "  ####  ", "   ##   ", "  ##    ",
        "##    ##", "## ## ##", "   ##   ", "   ##   ", "  ##    ", "  ##    ",
        "##    ##", "## ## ##", "  ####  ", "   ##   ", " ##     ", "  ##    ",
        " ##  ## ", "########", " ##  ## ", "   ##   ", "##     #", "  ##    ",
        "  ####  ", " ##  ## ", "##    ##", "   ##   ", "##    ##", "  ##    ",
        "   ##   ", " ##  ## ", "##    ##", "  ####  ", "########", "  ####  ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",

        "        ", "        ", "   #    ", "        ", "  ##    ", "        ",
        "        ", "        ", "  ###   ", "        ", "  ##    ", "        ",
        "        ", "  ####  ", " ## ##  ", "        ", "   ##   ", "        ",
        "#       ", "    ##  ", "##   ## ", "        ", "        ", "        ",
        "##      ", "    ##  ", "        ", "        ", "        ", "        ",
        "###     ", "    ##  ", "        ", "        ", "        ", " ####   ",
        " ###    ", "    ##  ", "        ", "        ", "        ", "    ##  ",
        "  ###   ", "    ##  ", "        ", "        ", "        ", " #####  ",
        "   ###  ", "    ##  ", "        ", "        ", "        ", "##  ##  ",
        "    ### ", "    ##  ", "        ", "        ", "        ", "##  ##  ",
        "     ## ", "    ##  ", "        ", "        ", "        ", "##  ##  ",
        "      # ", "  ####  ", "        ", "        ", "        ", " ### ## ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "########", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",

        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "###     ", "        ", "   ###  ", "        ", "  ###   ", "        ",
        " ##     ", "        ", "    ##  ", "        ", " ## ##  ", "        ",
        " ##     ", "        ", "    ##  ", "        ", " ##  #  ", "        ",
        " ####   ", " #####  ", "  ####  ", " #####  ", " ##     ", " ### ## ",
        " ## ##  ", "##   ## ", " ## ##  ", "##   ## ", "####    ", "##  ##  ",
        " ##  ## ", "##      ", "##  ##  ", "####### ", " ##     ", "##  ##  ",
        " ##  ## ", "##      ", "##  ##  ", "##      ", " ##     ", "##  ##  ",
        " ##  ## ", "##      ", "##  ##  ", "##      ", " ##     ", "##  ##  ",
        " ##  ## ", "##   ## ", "##  ##  ", "##   ## ", " ##     ", "##  ##  ",
        " #####  ", " #####  ", " ### ## ", " #####  ", "####    ", " #####  ",
        "        ", "        ", "        ", "        ", "        ", "    ##  ",
        "        ", "        ", "        ", "        ", "        ", "##  ##  ",
        "        ", "        ", "        ", "        ", "        ", " ####   ",
        "        ", "        ", "        ", "        ", "        ", "        ",

        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "###     ", "   ##   ", "     ## ", "###     ", "  ###   ", "        ",
        " ##     ", "   ##   ", "     ## ", " ##     ", "   ##   ", "        ",
        " ##     ", "        ", "        ", " ##     ", "   ##   ", "        ",
        " ## ##  ", "  ###   ", "    ### ", " ##  ## ", "   ##   ", "###  ## ",
        " ### ## ", "   ##   ", "     ## ", " ## ##  ", "   ##   ", "########",
        " ##  ## ", "   ##   ", "     ## ", " ####   ", "   ##   ", "## ## ##",
        " ##  ## ", "   ##   ", "     ## ", " ####   ", "   ##   ", "## ## ##",
        " ##  ## ", "   ##   ", "     ## ", " ## ##  ", "   ##   ", "## ## ##",
        " ##  ## ", "   ##   ", "     ## ", " ##  ## ", "   ##   ", "## ## ##",
        "###  ## ", "  ####  ", "     ## ", "###  ## ", "  ####  ", "## ## ##",
        "        ", "        ", " ##  ## ", "        ", "        ", "        ",
        "        ", "        ", " ##  ## ", "        ", "        ", "        ",
        "        ", "        ", "  ####  ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",

        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "## ###  ", " #####  ", "## ###  ", " ### ## ", "## ###  ", " #####  ",
        " ##  ## ", "##   ## ", " ##  ## ", "##  ##  ", " ### ## ", "##   ## ",
        " ##  ## ", "##   ## ", " ##  ## ", "##  ##  ", " ##  ## ", " ##     ",
        " ##  ## ", "##   ## ", " ##  ## ", "##  ##  ", " ##     ", "  ###   ",
        " ##  ## ", "##   ## ", " ##  ## ", "##  ##  ", " ##     ", "    ##  ",
        " ##  ## ", "##   ## ", " ##  ## ", "##  ##  ", " ##     ", "##   ## ",
        " ##  ## ", " #####  ", " #####  ", " #####  ", "####    ", " #####  ",
        "        ", "        ", " ##     ", "    ##  ", "        ", "        ",
        "        ", "        ", " ##     ", "    ##  ", "        ", "        ",
        "        ", "        ", "####    ", "   #### ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",

        "        ", "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ", "        ",
        "   #    ", "        ", "        ", "        ", "        ", "        ",
        "  ##    ", "        ", "        ", "        ", "        ", "        ",
        "  ##    ", "        ", "        ", "        ", "        ", "        ",
        "######  ", "##  ##  ", "##    ##", "##    ##", "##    ##", "##   ## ",
        "  ##    ", "##  ##  ", "##    ##", "##    ##", " ##  ## ", "##   ## ",
        "  ##    ", "##  ##  ", "##    ##", "##    ##", "  ####  ", "##   ## ",
        "  ##    ", "##  ##  ", "##    ##", "## ## ##", "   ##   ", "##   ## ",
        "  ##    ", "##  ##  ", " ##  ## ", "## ## ##", "  ####  ", "##   ## ",
        "  ## ## ", "##  ##  ", "  ####  ", "########", " ##  ## ", "##   ## ",
        "   ###  ", " ### ## ", "   ##   ", " ##  ## ", "##    ##", " ###### ",
        "        ", "        ", "        ", "        ", "        ", "     ## ",
        "        ", "        ", "        ", "        ", "        ", "    ##  ",
        "        ", "        ", "        ", "        ", "        ", "#####   ",
        "        ", "        ", "        ", "        ", "        ", "        ",

        "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ",
        "        ", "    ### ", "   ##   ", " ###    ", " ### ## ",
        "        ", "   ##   ", "   ##   ", "   ##   ", "## ###  ",
        "        ", "   ##   ", "   ##   ", "   ##   ", "        ",
        "####### ", "   ##   ", "   ##   ", "   ##   ", "        ",
        "##  ##  ", " ###    ", "        ", "    ### ", "        ",
        "   ##   ", "   ##   ", "   ##   ", "   ##   ", "        ",
        "  ##    ", "   ##   ", "   ##   ", "   ##   ", "        ",
        " ##     ", "   ##   ", "   ##   ", "   ##   ", "        ",
        "##   ## ", "   ##   ", "   ##   ", "   ##   ", "        ",
        "####### ", "    ### ", "   ##   ", " ###    ", "        ",
        "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ",
        "        ", "        ", "        ", "        ", "        ",
    ];
#end
}
